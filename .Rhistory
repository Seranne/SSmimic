finaltable$marital_status <- ifelse(grepl("MARRIED",finaltable$marital_status),"MARRIED", finaltable$marital_status)
finaltable$marital_status <- ifelse(grepl("LIFE PARTNER",finaltable$marital_status),"MARRIED", finaltable$marital_status)
finaltable$marital_status <- ifelse(grepl("DIVORCED",finaltable$marital_status),"DIVORCED/WIDOWED", finaltable$marital_status)
finaltable$marital_status <- ifelse(grepl("SEPARATED",finaltable$marital_status),"DIVORCED/WIDOWED", finaltable$marital_status)
finaltable$marital_status <- ifelse(grepl("WIDOW",finaltable$marital_status),"DIVORCED/WIDOWED", finaltable$marital_status)
finaltable$marital_status <- ifelse(grepl("UN",finaltable$marital_status),"OTHER", finaltable$marital_status)
finaltable$marital_status[is.na(finaltable$marital_status)]<-"OTHER"
#categorize insurance into 3 catergories
finaltable$insurance <- ifelse(grepl("Medi",finaltable$insurance),"Government", finaltable$insurance)
#check that ethnicity, marital status and insurance were correctly categorised
unique(finaltable$ethnicity)
unique(finaltable$marital_status)
unique(finaltable$insurance)
finaltable <- read_csv("~/SSmimic/Final Code and Write Up/finaltable.csv")
# categorize race into 4 categories
finaltable$ethnicity <- ifelse(grepl("BLACK",finaltable$ethnicity),"BLACK", finaltable$ethnicity)
finaltable$ethnicity <- ifelse(grepl("WHITE",finaltable$ethnicity),"WHITE", finaltable$ethnicity)
finaltable$ethnicity <- ifelse(grepl("HISPANIC",finaltable$ethnicity),"HISPANIC", finaltable$ethnicity)
finaltable$ethnicity <- ifelse(grepl("ASIAN",finaltable$ethnicity),"OTHER", finaltable$ethnicity)
finaltable$ethnicity <- ifelse(grepl("UN",finaltable$ethnicity),"OTHER", finaltable$ethnicity)
finaltable$ethnicity <- ifelse(grepl("MUL",finaltable$ethnicity),"OTHER", finaltable$ethnicity)
finaltable$ethnicity <- ifelse(grepl("INDIAN",finaltable$ethnicity),"OTHER", finaltable$ethnicity)
finaltable$ethnicity <- ifelse(grepl("SOUTH",finaltable$ethnicity),"OTHER", finaltable$ethnicity)
finaltable$ethnicity <- ifelse(grepl("ISLAND",finaltable$ethnicity),"OTHER", finaltable$ethnicity)
finaltable$ethnicity <- ifelse(grepl("DECL",finaltable$ethnicity),"OTHER", finaltable$ethnicity)
finaltable$ethnicity <- ifelse(grepl("EAST",finaltable$ethnicity),"OTHER", finaltable$ethnicity)
finaltable$ethnicity <- ifelse(grepl("PORTU",finaltable$ethnicity),"HISPANIC", finaltable$ethnicity)
finaltable$ethnicity[is.na(finaltable$ethnicity)]<-"OTHER"
#categorize marital status into 4 categories
finaltable$marital_status <- ifelse(grepl("MARRIED",finaltable$marital_status),"MARRIED", finaltable$marital_status)
finaltable$marital_status <- ifelse(grepl("LIFE PARTNER",finaltable$marital_status),"MARRIED", finaltable$marital_status)
finaltable$marital_status <- ifelse(grepl("DIVORCED",finaltable$marital_status),"DIVORCED/WIDOWED", finaltable$marital_status)
finaltable$marital_status <- ifelse(grepl("SEPARATED",finaltable$marital_status),"DIVORCED/WIDOWED", finaltable$marital_status)
finaltable$marital_status <- ifelse(grepl("WIDOW",finaltable$marital_status),"DIVORCED/WIDOWED", finaltable$marital_status)
finaltable$marital_status <- ifelse(grepl("UN",finaltable$marital_status),"OTHER", finaltable$marital_status)
finaltable$marital_status[is.na(finaltable$marital_status)]<-"OTHER"
#categorize insurance into 3 catergories
finaltable$insurance <- ifelse(grepl("Medi",finaltable$insurance),"Government", finaltable$insurance)
#check that ethnicity, marital status and insurance were correctly categorised
unique(finaltable$ethnicity)
unique(finaltable$marital_status)
unique(finaltable$insurance)
sum(is.na(finaltable$insurance))
sum(is.na(finaltable$e_score))
sum(is.na(finaltable$oasis))
sum(is.na(finaltable$oasis))
sum(is.na(finaltable$insurance))
sum(is.na(finaltable$oasis))
View(finaltable)
finaltable2<- na.omit(finaltable$admityear)
finaltable$admityear<- na.omit(finaltable$admityear)
finaltable<- na.omit(finaltable$admityear)
finaltable <- read_csv("~/SSmimic/Final Code and Write Up/finaltable.csv")
finaltable[!is.na(finaltable$admityear),]
finaltable <- read_csv("~/SSmimic/Final Code and Write Up/finaltable.csv")
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(mgcv)
library(dplyr)
require("RPostgreSQL")
library(stringr)
library(tidyverse)
library(readr)
finaltable <- read_csv("~/SSmimic/Final Code and Write Up/finaltable.csv")
finaltable[!is.na(finaltable$admityear),]
finaltable<- finaltable[!is.na(finaltable$admityear),]
# categorize race into 4 categories
finaltable$ethnicity <- ifelse(grepl("BLACK",finaltable$ethnicity),"BLACK", finaltable$ethnicity)
finaltable$ethnicity <- ifelse(grepl("WHITE",finaltable$ethnicity),"WHITE", finaltable$ethnicity)
finaltable$ethnicity <- ifelse(grepl("HISPANIC",finaltable$ethnicity),"HISPANIC", finaltable$ethnicity)
finaltable$ethnicity <- ifelse(grepl("ASIAN",finaltable$ethnicity),"OTHER", finaltable$ethnicity)
finaltable$ethnicity <- ifelse(grepl("UN",finaltable$ethnicity),"OTHER", finaltable$ethnicity)
finaltable$ethnicity <- ifelse(grepl("MUL",finaltable$ethnicity),"OTHER", finaltable$ethnicity)
finaltable$ethnicity <- ifelse(grepl("INDIAN",finaltable$ethnicity),"OTHER", finaltable$ethnicity)
finaltable$ethnicity <- ifelse(grepl("SOUTH",finaltable$ethnicity),"OTHER", finaltable$ethnicity)
finaltable$ethnicity <- ifelse(grepl("ISLAND",finaltable$ethnicity),"OTHER", finaltable$ethnicity)
finaltable$ethnicity <- ifelse(grepl("DECL",finaltable$ethnicity),"OTHER", finaltable$ethnicity)
finaltable$ethnicity <- ifelse(grepl("EAST",finaltable$ethnicity),"OTHER", finaltable$ethnicity)
finaltable$ethnicity <- ifelse(grepl("PORTU",finaltable$ethnicity),"HISPANIC", finaltable$ethnicity)
finaltable$ethnicity[is.na(finaltable$ethnicity)]<-"OTHER"
#categorize marital status into 4 categories
finaltable$marital_status <- ifelse(grepl("MARRIED",finaltable$marital_status),"MARRIED", finaltable$marital_status)
finaltable$marital_status <- ifelse(grepl("LIFE PARTNER",finaltable$marital_status),"MARRIED", finaltable$marital_status)
finaltable$marital_status <- ifelse(grepl("DIVORCED",finaltable$marital_status),"DIVORCED/WIDOWED", finaltable$marital_status)
finaltable$marital_status <- ifelse(grepl("SEPARATED",finaltable$marital_status),"DIVORCED/WIDOWED", finaltable$marital_status)
finaltable$marital_status <- ifelse(grepl("WIDOW",finaltable$marital_status),"DIVORCED/WIDOWED", finaltable$marital_status)
finaltable$marital_status <- ifelse(grepl("UN",finaltable$marital_status),"OTHER", finaltable$marital_status)
finaltable$marital_status[is.na(finaltable$marital_status)]<-"OTHER"
#categorize insurance into 3 catergories
finaltable$insurance <- ifelse(grepl("Medi",finaltable$insurance),"Government", finaltable$insurance)
#check that ethnicity, marital status and insurance were correctly categorised
unique(finaltable$ethnicity)
unique(finaltable$marital_status)
unique(finaltable$insurance)
library(readr)
library(tidyverse)
library(ggplot2)
library(dplyr)
library(sjPlot)
finaltable <- read_csv("~/SSmimic/Final Code and Write Up/finaltable.csv")
head(finaltable)
unique(finaltable$drug)
sum(finaltable$formulary_drug_cd == "1" )
library(survival)
finaltable <- read_csv("~/SSmimic/Final Code and Write Up/finaltable.csv")
finaltable<- finaltable[!is.na(finaltable$admityear),]
finaltable <- read_csv("~/SSmimic/Final Code and Write Up/finaltable.csv")
finaltable<- finaltable[!is.na(finaltable$admityear),]
# categorize race into 4 categories
finaltable$ethnicity <- ifelse(grepl("BLACK",finaltable$ethnicity),"BLACK", finaltable$ethnicity)
finaltable$ethnicity <- ifelse(grepl("WHITE",finaltable$ethnicity),"WHITE", finaltable$ethnicity)
finaltable$ethnicity <- ifelse(grepl("HISPANIC",finaltable$ethnicity),"HISPANIC", finaltable$ethnicity)
finaltable$ethnicity <- ifelse(grepl("ASIAN",finaltable$ethnicity),"OTHER", finaltable$ethnicity)
finaltable$ethnicity <- ifelse(grepl("UN",finaltable$ethnicity),"OTHER", finaltable$ethnicity)
finaltable$ethnicity <- ifelse(grepl("MUL",finaltable$ethnicity),"OTHER", finaltable$ethnicity)
finaltable$ethnicity <- ifelse(grepl("INDIAN",finaltable$ethnicity),"OTHER", finaltable$ethnicity)
finaltable$ethnicity <- ifelse(grepl("SOUTH",finaltable$ethnicity),"OTHER", finaltable$ethnicity)
finaltable$ethnicity <- ifelse(grepl("ISLAND",finaltable$ethnicity),"OTHER", finaltable$ethnicity)
finaltable$ethnicity <- ifelse(grepl("DECL",finaltable$ethnicity),"OTHER", finaltable$ethnicity)
finaltable$ethnicity <- ifelse(grepl("EAST",finaltable$ethnicity),"OTHER", finaltable$ethnicity)
finaltable$ethnicity <- ifelse(grepl("PORTU",finaltable$ethnicity),"HISPANIC", finaltable$ethnicity)
finaltable$ethnicity[is.na(finaltable$ethnicity)]<-"OTHER"
#categorize marital status into 4 categories
finaltable$marital_status <- ifelse(grepl("MARRIED",finaltable$marital_status),"MARRIED", finaltable$marital_status)
finaltable$marital_status <- ifelse(grepl("LIFE PARTNER",finaltable$marital_status),"MARRIED", finaltable$marital_status)
finaltable$marital_status <- ifelse(grepl("DIVORCED",finaltable$marital_status),"DIVORCED/WIDOWED", finaltable$marital_status)
finaltable$marital_status <- ifelse(grepl("SEPARATED",finaltable$marital_status),"DIVORCED/WIDOWED", finaltable$marital_status)
finaltable$marital_status <- ifelse(grepl("WIDOW",finaltable$marital_status),"DIVORCED/WIDOWED", finaltable$marital_status)
finaltable$marital_status <- ifelse(grepl("UN",finaltable$marital_status),"OTHER", finaltable$marital_status)
finaltable$marital_status[is.na(finaltable$marital_status)]<-"OTHER"
#categorize insurance into 3 catergories
finaltable$insurance <- ifelse(grepl("Medi",finaltable$insurance),"Government", finaltable$insurance)
#check that ethnicity, marital status and insurance were correctly categorised
unique(finaltable$ethnicity)
unique(finaltable$marital_status)
unique(finaltable$insurance)
write.csv(finaltable, file = "finaltable.csv")
library(readr)
library(tidyverse)
library(ggplot2)
library(dplyr)
library(sjPlot)
finaltable <- read_csv("~/SSmimic/Final Code and Write Up/finaltable.csv")
head(finaltable)
unique(finaltable$drug)
sum(finaltable$formulary_drug_cd == "1" )
library(survival)
finaltable <- read_csv("~/SSmimic/Final Code and Write Up/finaltable.csv")
finaltable <- read_csv("~/SSmimic/Final Code and Write Up/finaltable.csv")
finaltable$insurance<- as.factor(finaltable$insurance)
finaltable$ethnicity<- as.factor(finaltable$ethnicity)
finaltable$marital_status<- as.factor(finaltable$marital_status)
finaltable$ethnicity<- relevel(finaltable$ethnicity, ref = "WHITE")
finaltable$marital_status<- relevel(finaltable$marital_status, ref = "MARRIED")
finaltable0205<- filter(finaltable, finaltable$admityear == "2002" |finaltable$admityear == "2003" |finaltable$admityear == "2004" |finaltable$admityear == "2005" )
year2002_2005 <- ggplot(finaltable0205, aes(ethnicity, fill = drug == "1")) +
geom_bar(position = "fill") +
labs(x = "Ethnicity", fill = "Received IV Opioids")
year2002_2005
finaltable0608<- filter(finaltable, finaltable$admityear == "2006" |finaltable$admityear == "2007" |finaltable$admityear == "2008")
year2006_2008 <- ggplot(finaltable0608, aes(ethnicity, fill = drug == "1")) +
geom_bar(position = "fill") +
labs(x = "Ethnicity", fill = "Received IV Opioids")
year2006_2008
finaltable0911<- filter(finaltable, finaltable$admityear == "2009" |finaltable$admityear == "2010" |finaltable$admityear == "2011")
year2009_2011 <- ggplot(finaltable0911, aes(ethnicity, fill = drug == "1")) +
geom_bar(position = "fill") +
labs(x = "Ethnicity", fill = "Received IV Opioids")
year2009_2011
=======
>>>>>>> 20aff4128f47a57318c2f2338b78c16aff6a6386
>>>>>>> 3c45aa62afc0c68672f12ea05e478ac249393885
>>>>>>> 08d56d768c23b73dda403c70bedcbabc76d1b4e8
regfinal <- glm(finaltable$drug ~ finaltable$ethnicity + finaltable$mean.pain + finaltable$gender + finaltable$age + finaltable$insurance + finaltable$marital_status + finaltable$oasis, family = binomial(link = "logit"))
summary(regfinal)
confint(regfinal)
exp(coefficients(regfinal))
exp(confint(regfinal))
sjp.glm(regfinal)
library(sjPlot)
regfinal <- glm(finaltable$drug ~ finaltable$ethnicity + finaltable$mean.pain + finaltable$gender + finaltable$age + finaltable$insurance + finaltable$marital_status + finaltable$oasis, family = binomial(link = "logit"))
summary(regfinal)
confint(regfinal)
exp(coefficients(regfinal))
exp(confint(regfinal))
sjp.glm(regfinal)
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(mgcv)
library(dplyr)
require("RPostgreSQL")
library(stringr)
library(tidyverse)
library(readr)
library(sjPlot)
# Loads the PostgreSQL driver
drv <- dbDriver("PostgreSQL")
# Creates a connection to the postgres database (MIMIC)
# Note that "con" will be used later in each connection to the database
con <- dbConnect(drv, dbname = "mimic",
host = "localhost", port = 5432,
user = "postgres", password = "postgres")
dbGetQuery(con, "set search_path to mimiciii")
# First table contains subject_id, hadm_id, icustay_id, age, gender, ethnicity, marital status, insurance status, los_hospital, los_icu. Excludes patients with ICD-9 diagnoses codes for drug dependence or abuse
# SQL code for Materialized View "ptdetails" available from SQLCode.txt
ptdetails <- dbGetQuery(con, "select * from patientdetails")
# adding admityear: Permissions required to access Year data
years <- read_csv("/SSmimic/years.csv")
ptdetails <- merge(ptdetails, years, by = "hadm_id")
# Filter out years 2001 and 2012 as they are incomplete years
ptdetails <- filter(ptdetails, !ptdetails$admityear == "2001" & !ptdetails$admityear == "2012")
# Sets pts >89 yo (300 yo in database) to the median of 91.4
ptdetails$age[which(ptdetails$age > 300)] <- 91.4
# Removing duplicates
ptdetails <- ptdetails[-which(duplicated(ptdetails$hadm_id)),]
# Search through d_items table (containing item ids from both Metavision and CareVue databases) to derive item ids reflecting self-reported pain scores recorded in MIMIC
pain_items <- dbGetQuery(con, "select itemid, label from d_items where label like  '%pain%' or label like '%Pain%'")
pain_items
# Select all pain level measurements from the chartevents table and convert all measures to the same format
pain_table <- dbGetQuery(con, "select * from mimiciii.chartevents where itemid  in (1044, 1045, 225813, 224409, 227881, 223791)")
for(i in 1:nrow(pain_table)){
if(length(
unique(na.omit(as.numeric(unlist(strsplit(unlist(pain_table$value[i]),
"[^0-9]+")))))) == 1){
pain_table$valuenum[i] <- unique(na.omit(as.numeric(unlist(strsplit(unlist(pain_table$value[i]),
"[^0-9]+")))))
}
if(length(
unique(na.omit(as.numeric(unlist(strsplit(unlist(pain_table$value[i]),
"[^0-9]+")))))) == 2){
pain_table$valuenum[i] <- 0
}
}
# Calculate mean, median, and max pain scores for each patient per hospital stay. Return histogram of findings.
avg.pain <- aggregate(valuenum ~ hadm_id, data = pain_table, mean)
colnames(avg.pain) = c("hadm_id", "mean.pain")
max.pain <- aggregate(valuenum ~ hadm_id, data = pain_table, max)
colnames(max.pain) = c("hadm_id", "max_pain")
max.pain$max_pain <- as.numeric(max.pain$max_pain)
med.pain <- aggregate(valuenum ~ hadm_id, data = pain_table, median)
colnames(med.pain) = c("hadm_id", "med.pain")
med.pain$med.pain <- as.numeric(med.pain$med.pain)
# Extract OASIS scores from MIMIC
oasis <- dbGetQuery(con, "select subject_id, oasis from oasis")
write.csv(oasis, file = "oasis.csv")
oasis <- read_csv("/SSmimic/Final Code and Write up/oasis.csv")
# Eliminate duplicates in oasis
oasis <- oasis[-which(duplicated(oasis$subject_id)),]
# Extract Elixhauser scores from MIMIC
elix <- dbGetQuery(con, "select * from mimiciii.elixhauser_ahrq_no_drg_all_icd")
elix$e_score <- apply(elix[,3:32], 1, sum)
# Table will contain only patients for whom avg.pain scores are available
main.table <- merge(x = ptdetails, y = avg.pain, all.x = F, all.y = T)
main.table <- merge(x = main.table, y = max.pain, all.x = T, all.y = F)
main.table <- merge(x = main.table, y = med.pain, all.x = T, all.y = F)
main.table <- merge(x = main.table, y = oasis, all.x = T, all.y = F)
main.table <- merge(x = main.table, y = elix[,c(2,33)], all.x = T, all.y = F)
# Exclude patients with an Elixhauser score that is 10 or more
main.table <- filter(main.table, main.table$e_score < 10)
write.csv(main.table, file = "Main Table.csv")
main.table <- read_csv("/SSmimic/Final Code and Write Up/main.table.csv")
# Save hadm_id from cohort to use in medication extraction
write.csv(main.table$hadm_id, "./cohort_hadmi_id.csv")
# Extract drugs from Prescriptions, and write .csv files for each:
fentanyl <- dbGetQuery(con, "select * from Fentanyl")
morphine <- dbGetQuery(con, "select * from Morphine")
oxycodone <- dbGetQuery(con, "select * from Oxycodone")
hydrocodone <- dbGetQuery(con, "select * from Hydrocodone")
percocet <- dbGetQuery(con, "select * from Percocet")
hydromorphone <- dbGetQuery(con, "select * from Hydromorphone")
methadone <- dbGetQuery(con, "select * from Methadone")
write.csv(fentanyl, file = "Fentanyl.csv")
write.csv(morphine, file = "Morphine.csv")
write.csv(oxycodone, file = "Oxycodone.csv")
write.csv(hydrocodone, file = "Hydrocodone.csv")
write.csv(percocet, file = "Percocet.csv")
write.csv(hydromorphone, file = "Hydromorphone.csv")
write.csv(methadone, file = "Methadone.csv")
Fentanyl <- read_csv("/SSmimic/Medication/Fentanyl.csv")
Hydromorphone <- read_csv("/SSmimic/Medication/Hydromorphone.csv")
Morphine <- read_csv("/SSmimic/Medication/Morphine.csv")
Oxycodone <- read_csv("/SSmimic/Medication/Oxycodone.csv")
Percocet <- read_csv("/SSmimic/Medication/Percocet.csv")
Hydrocodone <- read_csv("/SSmimic/Medication/Hydrocodone.csv")
Methadone <- read_csv("/SSmimic/Medication/Methadone.csv")
#create tables with no duplicated hadm_id
Fent<- Fentanyl %>% distinct(hadm_id, .keep_all = TRUE) %>% select(., "X1", "subject_id", "hadm_id", "drug", "formulary_drug_cd", "drug_name_generic", "form_unit_disp", "route")
Hydrom<- Hydromorphone %>% distinct(hadm_id, .keep_all = TRUE)%>% select(., "X1", "subject_id", "hadm_id", "drug", "formulary_drug_cd", "drug_name_generic", "form_unit_disp", "route")
Morph<- Morphine %>% distinct(hadm_id, .keep_all = TRUE) %>% select(., "X1", "subject_id", "hadm_id", "drug", "formulary_drug_cd", "drug_name_generic", "form_unit_disp", "route")
Oxycod<- Oxycodone %>% distinct(hadm_id, .keep_all = TRUE) %>% select(., "X1", "subject_id", "hadm_id", "drug", "formulary_drug_cd", "drug_name_generic", "form_unit_disp", "route")
Perco <- Percocet %>% distinct(hadm_id, .keep_all = TRUE)%>% select(., "X1", "subject_id", "hadm_id", "drug", "formulary_drug_cd", "drug_name_generic", "form_unit_disp", "route")
Hydrocod<- Hydrocodone %>% distinct(hadm_id, .keep_all = TRUE) %>% select(., "X1", "subject_id", "hadm_id", "drug", "formulary_drug_cd", "drug_name_generic", "form_unit_disp", "route")
Meth <- Methadone %>% distinct(hadm_id, .keep_all = TRUE)
#create combined opioid medication table
opioid <- rbind(Fent,Hydrom, Morph, Oxycod, Perco, Hydrocod, Meth)
opioid_nohadmid<-  opioid %>% distinct(hadm_id, .keep_all = TRUE)
#create csv
write.csv(opioid, file = "opioid.csv")
#create  table with only IV drug presiscriptions and remove duplicated hadm_id
IVtable<- opioid[(opioid$route == "IV") |(opioid$route == "IV DRIP")|(opioid$route == "IVPCA") , ]
IVtable_nodup<-  IVtable %>% distinct(hadm_id, .keep_all = TRUE)
write.csv(IVtable_nodup,file = "IVtable_nodup.csv")
#create  table with NO IV drug presiscriptions and remove duplicated hadm_id
oralopioid<- opioid[!((opioid$route == "IV") |(opioid$route == "IV DRIP")|(opioid$route == "IVPCA")), ]
oralopioid_nodup<-  oralopioid %>% distinct(hadm_id, .keep_all = TRUE)
write.csv(oralopioid_nodup,file = "oralopioid_nodup.csv")
finaltable <- left_join(main.table , IVtable_nodup, "hadm_id")
finaltable <-  select(finaltable, "subject_id.y", "hadm_id", "icustay_id", "age", "gender", "ethnicity", "marital_status", "insurance", "los_hospital", "los_icu", "admityear", "mean.pain", "med.pain", "max_pain", "oasis", "e_score", "drug")
colnames(finaltable)[1] <- "subject_id"
unique(finaltable$drug)
finaltable$drug[finaltable$drug == "D5W"] <- NA
finaltable$drug[finaltable$drug == "Hydrocortisone Na Succinate"] <- NA
finaltable$drug[finaltable$drug == "Soln."] <- NA
finaltable$drug[finaltable$drug == "Soln"] <- NA
finaltable$drug[finaltable$drug == "Hydrocortiso"] <- NA
finaltable$drug[finaltable$drug == "Syringe"] <- NA
finaltable$drug[finaltable$drug == "5% Dextrose"] <- NA
unique(finaltable$drug)
# Replacing NA to 0 and receiving an IV opioid to 1:
finaltable$drug<- ifelse(is.na(finaltable$drug),0,1)
View(finaltable)
finaltable<- finaltable[!is.na(finaltable$admityear),]
# Sample size
length(unique(finaltable$hadm_id))
# categorize race into 4 categories
finaltable$ethnicity <- ifelse(grepl("BLACK",finaltable$ethnicity),"BLACK", finaltable$ethnicity)
finaltable$ethnicity <- ifelse(grepl("WHITE",finaltable$ethnicity),"WHITE", finaltable$ethnicity)
finaltable$ethnicity <- ifelse(grepl("HISPANIC",finaltable$ethnicity),"HISPANIC", finaltable$ethnicity)
finaltable$ethnicity <- ifelse(grepl("ASIAN",finaltable$ethnicity),"OTHER", finaltable$ethnicity)
finaltable$ethnicity <- ifelse(grepl("UN",finaltable$ethnicity),"OTHER", finaltable$ethnicity)
finaltable$ethnicity <- ifelse(grepl("MUL",finaltable$ethnicity),"OTHER", finaltable$ethnicity)
finaltable$ethnicity <- ifelse(grepl("INDIAN",finaltable$ethnicity),"OTHER", finaltable$ethnicity)
finaltable$ethnicity <- ifelse(grepl("SOUTH",finaltable$ethnicity),"OTHER", finaltable$ethnicity)
finaltable$ethnicity <- ifelse(grepl("ISLAND",finaltable$ethnicity),"OTHER", finaltable$ethnicity)
finaltable$ethnicity <- ifelse(grepl("DECL",finaltable$ethnicity),"OTHER", finaltable$ethnicity)
finaltable$ethnicity <- ifelse(grepl("EAST",finaltable$ethnicity),"OTHER", finaltable$ethnicity)
finaltable$ethnicity <- ifelse(grepl("PORTU",finaltable$ethnicity),"HISPANIC", finaltable$ethnicity)
finaltable$ethnicity[is.na(finaltable$ethnicity)]<-"OTHER"
#categorize marital status into 4 categories
finaltable$marital_status <- ifelse(grepl("MARRIED",finaltable$marital_status),"MARRIED", finaltable$marital_status)
finaltable$marital_status <- ifelse(grepl("LIFE PARTNER",finaltable$marital_status),"MARRIED", finaltable$marital_status)
finaltable$marital_status <- ifelse(grepl("DIVORCED",finaltable$marital_status),"DIVORCED/WIDOWED", finaltable$marital_status)
finaltable$marital_status <- ifelse(grepl("SEPARATED",finaltable$marital_status),"DIVORCED/WIDOWED", finaltable$marital_status)
finaltable$marital_status <- ifelse(grepl("WIDOW",finaltable$marital_status),"DIVORCED/WIDOWED", finaltable$marital_status)
finaltable$marital_status <- ifelse(grepl("UN",finaltable$marital_status),"OTHER", finaltable$marital_status)
finaltable$marital_status[is.na(finaltable$marital_status)]<-"OTHER"
#categorize insurance into 3 catergories
finaltable$insurance <- ifelse(grepl("Medi",finaltable$insurance),"Government", finaltable$insurance)
#check that ethnicity, marital status and insurance were correctly categorised
unique(finaltable$ethnicity)
unique(finaltable$marital_status)
unique(finaltable$insurance)
write.csv(finaltable, file = "finaltable.csv")
head(finaltable)
unique(finaltable$drug)
sum(finaltable$drug == "1" )
library(survival)
finaltable0205<- filter(finaltable, finaltable$admityear == "2002" |finaltable$admityear == "2003" |finaltable$admityear == "2004" |finaltable$admityear == "2005" )
finaltable0608<- filter(finaltable, finaltable$admityear == "2006" |finaltable$admityear == "2007" |finaltable$admityear == "2008")
finaltable0911<- filter(finaltable, finaltable$admityear == "2009" |finaltable$admityear == "2010" |finaltable$admityear == "2011")
globalplot <- ggplot(finaltable, aes(ethnicity, fill = drug == "1")) +
geom_bar(position = "fill") +
labs(x = "Ethnicity", fill = "Received IV Opioids") +
ggtitle("Race based distribution of IV opioids")
globalplot
length(unique(finaltable$subject_id))
length(unique(finaltable$hadm_id))
black<- filter(finaltable, finaltable$ethnicity == "BLACK")
length(black$subject_id)
length(black$hadm_id)
white<- filter(finaltable, finaltable$ethnicity == "WHITE")
length(unique(white$subject_id))
length(unique(white$hadm_id))
hispanic<- filter(finaltable, finaltable$ethnicity == "HISPANIC")
length(unique(hispanic$subject_id))
length(unique(hispanic$hadm_id))
other<- filter(finaltable, finaltable$ethnicity == "OTHER")
length(unique(other$subject_id))
length(unique(other$hadm_id))
sum(finaltable$ethnicity == "BLACK")
sum(finaltable$ethnicity == "WHITE")
sum(finaltable$ethnicity == "OTHER")
sum(finaltable$ethnicity == "HISPANIC")
sum(finaltable$insurance == "Government")
sum(finaltable$insurance == "Private")
sum(finaltable$insurance == "Self Pay")
sum(finaltable$gender == "F")
sum(finaltable$gender == "M")
summarize(finaltable, mean(oasis), sd(oasis))
summarize(finaltable, mean(mean.pain), sd(mean.pain))
ethnicgrouppain<- finaltable %>% group_by(ethnicity) %>% summarize(., mean(mean.pain), sd(mean.pain))
ethnicgrouppain
gendergrouppain<- finaltable %>% group_by(gender) %>% summarize(., mean(mean.pain), sd(mean.pain))
gendergrouppain
male<- filter(finaltable, finaltable$gender == "M")
sum(male$drug == "1")
female<- filter(finaltable, finaltable$gender == "F")
sum(female$drug == "1")
finaltable2<- filter(finaltable, finaltable$drug =="1")
sum(finaltable2$ethnicity == "BLACK")
sum(finaltable2$ethnicity == "WHITE")
sum(finaltable2$ethnicity == "OTHER")
sum(finaltable2$ethnicity == "HISPANIC")
sum(finaltable2$insurance == "Government")
sum(finaltable2$insurance == "Private")
sum(finaltable2$insurance == "Self Pay")
sum(finaltable2$gender == "F")
sum(finaltable2$gender == "M")
summarize(finaltable2, mean(oasis), sd(oasis))
summarize(finaltable2, mean(mean.pain), sd(mean.pain))
ethnicgrouppain2<- finaltable2 %>% group_by(ethnicity) %>% summarize(., mean(mean.pain), sd(mean.pain))
ethnicgrouppain2
gendergrouppain2<- finaltable2 %>% group_by(gender) %>% summarize(., mean(mean.pain), sd(mean.pain))
gendergrouppain2
male2<- filter(finaltable2, finaltable2$gender == "M")
sum(male2$drug == "1")
female2<- filter(finaltable2, finaltable2$gender == "F")
sum(female2$drug == "1")
sum(finaltable0205$ethnicity == "BLACK")
sum(finaltable0205$ethnicity == "WHITE")
sum(finaltable0205$ethnicity == "OTHER")
sum(finaltable0205$ethnicity == "HISPANIC")
sum(finaltable0608$ethnicity == "BLACK")
sum(finaltable0608$ethnicity == "WHITE")
sum(finaltable0608$ethnicity == "OTHER")
sum(finaltable0608$ethnicity == "HISPANIC")
sum(finaltable0911$ethnicity == "BLACK")
sum(finaltable0911$ethnicity == "WHITE")
sum(finaltable0911$ethnicity == "OTHER")
sum(finaltable0911$ethnicity == "HISPANIC")
finaltable$insurance<- as.factor(finaltable$insurance)
finaltable$ethnicity<- as.factor(finaltable$ethnicity)
finaltable0205$insurance<- as.factor(finaltable0205$insurance)
finaltable0205$ethnicity<- as.factor(finaltable0205$ethnicity)
finaltable0608$insurance<- as.factor(finaltable0608$insurance)
finaltable0608$ethnicity<- as.factor(finaltable0608$ethnicity)
finaltable0911$insurance<- as.factor(finaltable0911$insurance)
finaltable0911$ethnicity<- as.factor(finaltable0911$ethnicity)
finaltable$ethnicity<- relevel(finaltable$ethnicity, ref = "WHITE")
finaltable0911$ethnicity<- relevel(finaltable0911$ethnicity, ref = "WHITE")
finaltable0608$ethnicity<- relevel(finaltable0608$ethnicity, ref = "WHITE")
finaltable0205$ethnicity<- relevel(finaltable0205$ethnicity, ref = "WHITE")
library(tableone)
finaltablemutate <- mutate(finaltable, drug = as.factor(drug))
finaltablemutate$gender<- as.factor(finaltablemutate$gender)
finaltablemutate$gender<- relevel(finaltablemutate$gender, ref = "M")
CreateTableOne(vars = c("age",  "gender", "insurance", "mean.pain", "oasis","ethnicity"),strata = "drug", testApprox = chisq.test, data = finaltablemutate)
primarymodel <- glm(finaltable$drug ~ finaltable$ethnicity, family = binomial(link = "logit"))
summary(primarymodel)
confint(primarymodel)
exp(coefficients(primarymodel))
exp(confint(primarymodel))
sjp.glm(primarymodel)
year2002_2005 <- ggplot(finaltable0205, aes(ethnicity, fill = drug == "1")) +
geom_bar(position = "fill") +
labs(x = "Ethnicity", fill = "Received IV Opioids")
year2002_2005
years1 <- glm(finaltable0205$drug ~ finaltable0205$ethnicity, family = binomial(link = "logit"))
summary(years1)
confint(years1)
exp(coefficients(years1))
exp(confint(years1))
sjp.glm(years1)
year2006_2008 <- ggplot(finaltable0608, aes(ethnicity, fill = drug == "1")) +
geom_bar(position = "fill") +
labs(x = "Ethnicity", fill = "Received IV Opioids")
year2006_2008
years2 <- glm(finaltable0608$drug ~ finaltable0608$ethnicity, family = binomial(link = "logit"))
summary(years2)
confint(years2)
exp(coefficients(years2))
exp(confint(years2))
sjp.glm(years2)
year2009_2011 <- ggplot(finaltable0911, aes(ethnicity, fill = drug == "1")) +
geom_bar(position = "fill") +
labs(x = "Ethnicity", fill = "Received IV Opioids")
year2009_2011
years3 <- glm(finaltable0911$drug ~ finaltable0911$ethnicity, family = binomial(link = "logit"))
summary(years3)
confint(years3)
exp(coefficients(years3))
exp(confint(years3))
sjp.glm(years3)
secondlook <- glm(finaltable$drug ~ finaltable$ethnicity + finaltable$mean.pain + finaltable$gender + finaltable$age + finaltable$insurance + finaltable$oasis, family = binomial(link = "logit"))
summary(secondlook)
confint(secondlook)
exp(coefficients(secondlook))
exp(confint(secondlook))
sjPlot::plot_model(secondlook, show.values = TRUE, dot.size = 1, value.offset = 0.3, axis.labels = c("OASIS", "Mean Pain","Self pay Insurance","Private Insurance", "Male", "Other Ethnicity","Hispanic", "Black" ,"Age"  )) + ggtitle("Odds ratios of IV Opioid Prescription adjusting for all covariates")
year1secondlook <- glm(finaltable0205$drug ~ finaltable0205$ethnicity + finaltable0205$mean.pain + finaltable0205$gender + finaltable0205$age + finaltable0205$insurance + finaltable0205$oasis, family = binomial(link = "logit"))
summary(year1secondlook)
confint(year1secondlook)
exp(coefficients(year1secondlook))
exp(confint(year1secondlook))
sjPlot::plot_model(year1secondlook, show.values = TRUE, dot.size = 1, value.offset = 0.3, axis.labels = c("OASIS", "Mean Pain","Self pay Insurance","Private Insurance", "Male", "Other Ethnicity","Hispanic", "Black" ,"Age"  )) + ggtitle("Odds ratios of IV Opioid Prescription 2002-2005")
year2secondlook <- glm(finaltable0608$drug ~ finaltable0608$ethnicity + finaltable0608$mean.pain + finaltable0608$gender + finaltable0608$age + finaltable0608$insurance + finaltable0608$oasis, family = binomial(link = "logit"))
summary(year2secondlook)
confint(year2secondlook)
exp(coefficients(year2secondlook))
exp(confint(year2secondlook))
sjPlot::plot_model(year2secondlook, show.values = TRUE, dot.size = 1, value.offset = 0.3, axis.labels = c("OASIS", "Mean Pain","Self pay Insurance","Private Insurance", "Male", "Other Ethnicity","Hispanic", "Black" ,"Age"  )) + ggtitle("Odds ratios of IV Opioid Prescription 2006-2008")
year3secondlook <- glm(finaltable0911$drug ~ finaltable0911$ethnicity + finaltable0911$mean.pain + finaltable0911$gender + finaltable0911$age + finaltable0911$insurance  + finaltable0911$oasis, family = binomial(link = "logit"))
summary(year3secondlook)
confint(year3secondlook)
exp(coefficients(year3secondlook))
exp(confint(year3secondlook))
sjPlot::plot_model(year3secondlook, show.values = TRUE, dot.size = 1, value.offset = 0.3, axis.labels = c("OASIS", "Mean Pain","Self pay Insurance","Private Insurance", "Male", "Other Ethnicity","Hispanic", "Black" ,"Age"  )) + ggtitle("Odds ratios of IV Opioid Prescription 2009-2011")
secondlook2 <- glm(finaltable$drug ~ finaltable$ethnicity + finaltable$mean.pain + finaltable$gender + finaltable$age + finaltable$insurance + finaltable$oasis + finaltable$insurance*finaltable$age, family = binomial(link = "logit"))
summary(secondlook2)
confint(secondlook2)
exp(coefficients(secondlook2))
exp(confint(secondlook2))
