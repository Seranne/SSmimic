{
    "collab_server" : "",
    "contents" : "---\ntitle: \"MIMIC Pain Level Analysis\"\nauthor: \"Erik Doty\"\ndate: \"February 17, 2017\"\noutput:\n  html_document: default\n  pdf_document: default\n---\n\n```{r setup, include=FALSE}\nknitr::opts_chunk$set(echo = TRUE)\nlibrary(ggplot2)\nlibrary(mgcv)\nlibrary(dplyr)\n# install.packages(\"RPostgreSQL\") ##Install package if needed\nrequire(\"RPostgreSQL\")\nlibrary(stringr)\n```\n\n## Background\nThe following markdown is designed to search through the mimic database and find all patients who underwent CABG procedure. These patients will be found using CPT codes. The corresponding patients and there associated pain levels will also be searched for. We will use the MIMIC database to find additional factors such as medications used to sedate the pateint, surgical complications. Our goal is to see if these pain levels are potentially associated with worse patient outcomes. The outcomes of interest are hospital length of stay, 30 day mortality rate, and 1 year mortality rate. \n\n## Analysis Table Build\nThe first chunk of code allows R to conenct to MIMIC database \n```{r echo = F}\n# loads the PostgreSQL driver\ndrv <- dbDriver(\"PostgreSQL\") \n# creates a connection to the postgres database (MIMIC)\n# note that \"con\" will be used later in each connection to the database\ncon <- dbConnect(drv, dbname = \"mimic\",\n                 host = \"localhost\", port = 5432,\n                 user = \"postgres\", password = \"postgres\") # password and username were specific to my \n                                          # computer, removed here\n\ndbGetQuery(con, \"set search_path to mimiciii\")\n```\n```{r}\nicu_stay_table <- dbGetQuery(con, \"select subject_id, hadm_id, icustay_id, intime, los from icustays\")\ncolnames(icu_stay_table) <- c(\"subject_id\", \"hadm_id\", \"icustay_id\", \"intime\", \"icu_los\")\n```\n\nTo get other social factors from admissions: \n```{r}\nother.table <- dbGetQuery(con, \"select subject_id, hadm_id, insurance, marital_status\n                              from admissions\")\nView(other.table)\n# Remove duplicates\nother.table <- other.table[-which(duplicated(other.table$hadm_id)),]\n```\n\n\nThe following code chunks use tables derived from the MIMIC database to create a dataframe with all the variables of interest for each patient.\n\nSearch through d_items table to derive how pain is recorded in MIMIC\n```{r echo = T}\n#pain_items <- items <- dbGetQuery(con, \"select * from d_items where label like  '%pain%' or label like '%Pain%'\")\n#pain_items\n```\nLooking at the table these are the following item_ids that will be used to obtain pain level from the chartevents tables: 1044(Pain Level), 1045(Pain Level/Response), 225813(Baseline pain level), 224409, 227881 (Pain (0-10)), 223791 (Pain Level)\n\nSelects all those pain levels from the chartevents table and convert all measures to the same format\n```{r echo = T}\npain_table <- dbGetQuery(con, \"select * from mimiciii.chartevents where itemid  in (1044, 1045, 225813, 224409, 227881, 223791)\")\nfor(i in 1:nrow(pain_table)){\n  if(length(\n  unique(na.omit(as.numeric(unlist(strsplit(unlist(pain_table$value[i]), \n                                            \"[^0-9]+\")))))) == 1){\n    pain_table$valuenum[i] <- unique(na.omit(as.numeric(unlist(strsplit(unlist(pain_table$value[i]), \n                                                                 \"[^0-9]+\")))))\n  }\n  if(length(\n    unique(na.omit(as.numeric(unlist(strsplit(unlist(pain_table$value[i]), \n                                              \"[^0-9]+\")))))) == 2){\n                      pain_table$valuenum[i] <- 0\n                                              }\n}\n\nhead(pain_table)\nqplot(x = valuenum, data = pain_table, geom = \"histogram\") + ggtitle(\"Pain level Hist\")\n```\n\nCreate a table of all patient ages, another variable that will need to be controlled for\n\n```{r}\nView(icustay_detail)\n```\n\n```{r echo = T}\nage.table <- dbGetQuery(con, \"select subject_id, hadm_id, age, gender,ethnicity\n                              from icustay_detail\")\n# Remove duplicates\nage.table <- age.table[-which(duplicated(age.table$hadm_id)),]\n```\n\nTotal sample size\n```{r echo = T}\nlength(unique(pain_table$hadm_id)) # All CABG patients\n```\n\nCalculate mean, median, and max pains for patient  hospital stay. Return histogram of findings\n```{r echo = T}\navg.pain <- aggregate(valuenum ~ hadm_id, data = pain_table, mean)\ncolnames(avg.pain) = c(\"hadm_id\", \"mean.pain\")\nqplot(x = round(mean.pain), data = avg.pain, geom = \"histogram\") + ggtitle(\"Avg Pain level Hist\")\n\nmax.pain <- aggregate(valuenum ~ hadm_id, data = pain_table, max)\ncolnames(max.pain) = c(\"hadm_id\", \"max_pain\")\nmax.pain$max_pain <- as.numeric(max.pain$max_pain)\nqplot(x = max_pain, data = max.pain, geom = \"histogram\") + ggtitle(\" Max Pain level Hist\")\n\nmed.pain <- aggregate(valuenum ~ hadm_id, data = pain_table, median)\ncolnames(med.pain) = c(\"hadm_id\", \"med.pain\")\nmed.pain$med.pain <- as.numeric(med.pain$med.pain)\n\nqplot(x = med.pain, data = med.pain, geom = \"histogram\")\n```\n\nCreate admission data table, will be used to calculate length of stay and mortality rates\n\n\nExtracting OASIS scores from MIMIC\n```{r echo = T}\noasis <- dbGetQuery(con, \"select subject_id, oasis from oasis\")\n\n# Eliminates duplicates in oasis\noasis <- oasis[-which(duplicated(oasis$subject_id)),]\n```\n\n\nElixhauser score \n```{r echo = T}\nelix <- dbGetQuery(con, \"select * from mimiciii.elixhauser_ahrq_no_drg_all_icd\")\n\nelix$e_score <- apply(elix[,3:32], 1, sum)\n```\n\n\nSelect all the GCS values in MIMIC. GCS recorded differently if metavision or carvue system. carevue recorded total GCS, metavision recorded individual category scores. Select Mean, med, max\n```{r echo = T}\n# Carevue\nGCS_table1 <- dbGetQuery(con, \"select hadm_id, value from chartevents where itemid = 198\")\n\n# Metavision\nGCS_table2 <- dbGetQuery(con, \"select * from chartevents where itemid in (220739, 223900, 223901)\")\n\n# Following chunck used to sum all GCS categories in GCS_table2 to gather total scores. Collects also \nGCS_table2 <- GCS_table2 %>% group_by(hadm_id, charttime) %>% summarise(sum(valuenum), length(valuenum))\n\n# Eliminate unnecessarty columns and incomplete measurements of GCS\nGCS_table2 <- GCS_table2[which(GCS_table2$`length(valuenum)` == 3),c(-2, -4)]\ncolnames(GCS_table2) <- c(\"hadm_id\", \"value\")\nGCS_table2 <- as.data.frame(GCS_table2)\n\nGCS_table1$value <- as.numeric(GCS_table1$value)\n#Combine into single GCS table\nGCS <- bind_rows(GCS_table1, GCS_table2)\n\nGCS_agg <- GCS %>% group_by(hadm_id) %>% summarise(mean(value), min(value), max(value))\ncolnames(GCS_agg) <- c(\"hadm_id\", \"mean.GCS\", \"min.GCS\", \"max.GCS\")\n```\n\nMerge all tables into one main.table, will be used to run analysis\n```{r echo = T}\nmain.table <- merge(x = icu_stay_table, y = avg.pain, \n                    all.x = F, all.y = T)\nmain.table <- merge(x = max.pain, y = main.table, all.x = F, all.y = T)\nmain.table <- merge(x = age.table, y = main.table, all.x = F, all.y = T)\nmain.table <- merge(x = other.table, y = main.table, all.x = F, all.y = T)\n\nmain.table <- merge(x = main.table, y = oasis, all.x = T, all.y = F)\nmain.table <- merge(x = main.table, y = elix[,c(2,33)], all.x = T, all.y = F)\n\n\n# Add GCS table\nmain.table <- merge(x = main.table, y = GCS_agg, all.x = T, all.y = F)\n\n\n# Sets pts >89 yo (300 yo in database) to the median of 91.4\nmain.table$age[which(main.table$age > 300)] <- 91.4\n\nmain.table <- merge(x = med.pain, y = main.table, all.x = T, all.y = F)\n```\n\n\nMain Table\n```{r echo = F}\nwrite.csv(main.table, \"./main.table.csv\")\nView(main.table)\nhead(main.table)\n\nqplot(main.table$ventdur, shape = \"histogram\", binwidth = 12) #Histogram of ventilation durations\nlength(which(main.table$ventdur <= 24)) #Number of cases where vent duration is less than 24 hrs, 821\nqplot(main.table$age, shape = \"histogram\", binwidth = 1)\nqplot(round(main.table$mean.pain), shape = \"histogram\")\n\n#Save hadm_id from cohort to use in medication extraction\nwrite.csv(main.table$hadm_id, \"./cohort_hadmi_id.csv\")\n\n```\n",
    "created" : 1512144013682.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "415549044",
    "id" : "F4ADEC8F",
    "lastKnownWriteTime" : 1511399634,
    "last_content_update" : 1511399634,
    "path" : "~/SSmimic/Cohort/PainProjectSSlite.Rmd",
    "project_path" : "Cohort/PainProjectSSlite.Rmd",
    "properties" : {
    },
    "relative_order" : 7,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_markdown"
}