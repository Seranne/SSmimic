---
title: "Analysis"
output: html_document
---

```{r}
library(tidyverse)
library(readr)

IVopioid <- read_csv("~/SSmimic/Medication/IVtable_nodup.csv")
cohort <- read_csv("~/SSmimic/Cohort/cohort.csv")

#merger the tables to ease analysis

finaltable<- left_join(cohort,IVopioid, "hadm_id")

#Replacing NA to 0 and receiving an IV opioid to 1:

finaltable$formulary_drug_cd<- ifelse(is.na(finaltable$formulary_drug_cd),0,1)

#categorize race into 4 categories

finaltable$ethnicity <- ifelse(grepl("BLACK",finaltable$ethnicity),"BLACK", finaltable$ethnicity)
finaltable$ethnicity <- ifelse(grepl("WHITE",finaltable$ethnicity),"WHITE", finaltable$ethnicity)
finaltable$ethnicity <- ifelse(grepl("HISPANIC",finaltable$ethnicity),"HISPANIC", finaltable$ethnicity)
finaltable$ethnicity <- ifelse(grepl("ASIAN",finaltable$ethnicity),"OTHER", finaltable$ethnicity)
finaltable$ethnicity <- ifelse(grepl("UN",finaltable$ethnicity),"OTHER", finaltable$ethnicity)
finaltable$ethnicity <- ifelse(grepl("MUL",finaltable$ethnicity),"OTHER", finaltable$ethnicity)
finaltable$ethnicity <- ifelse(grepl("INDIAN",finaltable$ethnicity),"OTHER", finaltable$ethnicity)
finaltable$ethnicity <- ifelse(grepl("SOUTH",finaltable$ethnicity),"OTHER", finaltable$ethnicity)
finaltable$ethnicity <- ifelse(grepl("ISLAND",finaltable$ethnicity),"OTHER", finaltable$ethnicity)
finaltable$ethnicity <- ifelse(grepl("DECL",finaltable$ethnicity),"OTHER", finaltable$ethnicity)
finaltable$ethnicity <- ifelse(grepl("EAST",finaltable$ethnicity),"OTHER", finaltable$ethnicity)
finaltable$ethnicity <- ifelse(grepl("PORTU",finaltable$ethnicity),"HISPANIC", finaltable$ethnicity)

finaltable$ethnicity[is.na(finaltable$ethnicity)]<-"OTHER"

unique(finaltable$ethnicity)

#filter out years 2001 and 2012 as they are incomplete years

finaltable<- filter(finaltable, !finaltable$admityear == "2001" & !finaltable$admityear == "2012")

#write csv final table: cohort plus IV opioids woth no duplicated hadm_id's
write.csv(finaltable, file = "finaltable.csv")

```


