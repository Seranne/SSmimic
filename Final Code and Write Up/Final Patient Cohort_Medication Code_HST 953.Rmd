---
title: "Final Code_HST 953"
author: "Seranne Motilal and Shravanthi Seshasayee"
date: "1 December 2017"
output: html_document
---
## Background

The aim of our study is to identify if there is an association between a patient's demographic characteristics (age, gender, ethnicity, marital status and insurance coverage) and our outcome of interest: prescription of IV opioid medication (yes = 1, no = 0). We also investigate if this association has shown a difference in trends over time, between the years 2002 and 2011. 

The following markdown is designed to search through the mimic database and generate a table containing details of patients with self-reported pain scores between the years 2002 and 2011, their demographic and clinical characteristics, and corresponding IV opioid prescription information. 

All patients with ICD-9 codes corresponding with drug dependence and abuse have been excluded.Patients with elixhauser scores greater than 10 have been excluded.

# Subsetting Mimic for Final Cohort. 
Demographic Characteristics: 
- subject_id, hadm_id, icustay_id, age, gender, ethnicity, marital status, insurance status, admit year, 
Clinical Characteristics: 
- mean pain, median pain, max pain, icu_los, oasis, e_score, 
Prescription Characteristics: 
- drug, drug_name_generic, formulary_drug_cd, form_unit_disp, route
Inclusion Criteria
- All patients with self-reported pain scores
To Exclude: 
- All patients with ICD - 9 codes for Drug Dependence or Abuse [codes beginning with 304 or 305]
- All patients with Elixhauser scores > 10


```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(mgcv)
library(dplyr)
require("RPostgreSQL")
library(stringr)
library(tidyverse)
library(readr)
```

The first chunk of code allows R to connect to MIMIC database:
```{r echo = F}
# Loads the PostgreSQL driver
drv <- dbDriver("PostgreSQL") 

# Creates a connection to the postgres database (MIMIC)
# Note that "con" will be used later in each connection to the database

con <- dbConnect(drv, dbname = "mimic",
                 host = "localhost", port = 5432,
                 user = "postgres", password = "postgres")

dbGetQuery(con, "set search_path to mimiciii")
```

The following code chunks use tables derived from the MIMIC database to create a dataframe with all the variables of interest for each patient.

## Patient Details: Demographic and Admission Characteristics 
```{r echo = T, cache = TRUE}
# First table contains subject_id, hadm_id, icustay_id, age, gender, ethnicity, marital status, insurance status, los_hospital, los_icu. Excludes patients with ICD-9 diagnoses codes for drug dependence or abuse
# SQL code for Materialized View "ptdetails" available from SQLCode.txt
ptdetails <- dbGetQuery(con, "select * from patientdetails")

# adding admityear: Permissions required to access Year data
years <- read_csv("/SSmimic/years.csv")
ptdetails <- merge(ptdetails, years, by = "hadm_id")

# Filter out years 2001 and 2012 as they are incomplete years
ptdetails <- filter(ptdetails, !ptdetails$admityear == "2001" & !ptdetails$admityear == "2012")

# Sets pts >89 yo (300 yo in database) to the median of 91.4
ptdetails$age[which(ptdetails$age > 300)] <- 91.4

# Removing duplicates
ptdetails <- ptdetails[-which(duplicated(ptdetails$hadm_id)),]
```


## Patient Details: Clinical Characteristics 
# Pain scores
```{r echo = T, cache = TRUE}
# Search through d_items table (containing item ids from both Metavision and CareVue databases) to derive item ids reflecting self-reported pain scores recorded in MIMIC
pain_items <- dbGetQuery(con, "select itemid, label from d_items where label like  '%pain%' or label like '%Pain%'")
pain_items
```

Looking at the table above, these are the following item_ids that will be used to obtain pain level from the chartevents tables: 1044 (Pain Level - CareVue), 1045 (Pain Level/Response - CareVue), 225813 (Baseline pain level - Metavision), 224409 (Pain Level Response - Metavision), 227881 (Pain (0-10)), 223791 (Pain Level - Metavision).

```{r echo = T, cache = TRUE}
# Select all pain level measurements from the chartevents table and convert all measures to the same format
pain_table <- dbGetQuery(con, "select * from mimiciii.chartevents where itemid  in (1044, 1045, 225813, 224409, 227881, 223791)")
for(i in 1:nrow(pain_table)){
  if(length(
  unique(na.omit(as.numeric(unlist(strsplit(unlist(pain_table$value[i]), 
                                            "[^0-9]+")))))) == 1){
    pain_table$valuenum[i] <- unique(na.omit(as.numeric(unlist(strsplit(unlist(pain_table$value[i]), 
                                                                 "[^0-9]+")))))
  }
  if(length(
    unique(na.omit(as.numeric(unlist(strsplit(unlist(pain_table$value[i]), 
                                              "[^0-9]+")))))) == 2){
                      pain_table$valuenum[i] <- 0
                                              }
}

```


```{r echo = T, cache = TRUE}
# Calculate mean, median, and max pain scores for each patient per hospital stay. Return histogram of findings.
avg.pain <- aggregate(valuenum ~ hadm_id, data = pain_table, mean)
colnames(avg.pain) = c("hadm_id", "mean.pain")

max.pain <- aggregate(valuenum ~ hadm_id, data = pain_table, max)
colnames(max.pain) = c("hadm_id", "max_pain")
max.pain$max_pain <- as.numeric(max.pain$max_pain)

med.pain <- aggregate(valuenum ~ hadm_id, data = pain_table, median)
colnames(med.pain) = c("hadm_id", "med.pain")
med.pain$med.pain <- as.numeric(med.pain$med.pain)
```


```{r echo = T, cache = TRUE}
# Extract OASIS scores from MIMIC
oasis <- dbGetQuery(con, "select subject_id, oasis from oasis")
write.csv(oasis, file = "oasis.csv")
```

```{r}
oasis <- read_csv("/SSmimic/Final Code and Write up/oasis.csv")

# Eliminate duplicates in oasis
oasis <- oasis[-which(duplicated(oasis$subject_id)),]
```


```{r echo = T, cache = TRUE}
# Extract Elixhauser scores from MIMIC 
elix <- dbGetQuery(con, "select * from mimiciii.elixhauser_ahrq_no_drg_all_icd")
elix$e_score <- apply(elix[,3:32], 1, sum)
```

# Merge all above variables into one main cohort table, which will be used to run analysis
```{r echo = T, cache = TRUE}
# Table will contain only patients for whom avg.pain scores are available
main.table <- merge(x = ptdetails, y = avg.pain, all.x = F, all.y = T)
main.table <- merge(x = main.table, y = max.pain, all.x = T, all.y = F)
main.table <- merge(x = main.table, y = med.pain, all.x = T, all.y = F)
main.table <- merge(x = main.table, y = oasis, all.x = T, all.y = F)
main.table <- merge(x = main.table, y = elix[,c(2,33)], all.x = T, all.y = F)

# Exclude patients with an Elixhauser score that is 10 or more
main.table <- filter(main.table, main.table$e_score < 10)
```

# Generating Cohort Table
```{r echo = F}
write.csv(main.table, file = "Main Table.csv")
```

```{r, cache = TRUE}
main.table <- read.csv("/SSMimic/Final Code and Write Up/Main Table.csv")
```

```{r}
# Save hadm_id from cohort to use in medication extraction
write.csv(main.table$hadm_id, "./cohort_hadmi_id.csv")
```

## Medication: Opioid Medications were defined to include: 
Fentanyl, Remifentanil, Alfentanil, Sufentanil, Morphine, Oxycodone, Percocet, Hydrocodone, Hydrocodone Bitartrate, Oxycodone Hydrochloride, Hydromorphone Hydrochloride, and Methadone. SQL Codes for extracting these prescriptions from the table Prescriptions, are available from SQLCode.txt.

```{r, echo = TRUE, cache = TRUE}
# Extract drugs from Prescriptions, and write .csv files for each:
fentanyl <- dbGetQuery(con, "select * from Fentanyl")
morphine <- dbGetQuery(con, "select * from Morphine")
oxycodone <- dbGetQuery(con, "select * from Oxycodone")
hydrocodone <- dbGetQuery(con, "select * from Hydrocodone")
percocet <- dbGetQuery(con, "select * from Percocet")
hydromorphone <- dbGetQuery(con, "select * from Hydromorphone")
```

```{r, cache = TRUE}
write.csv(fentanyl, file = "Fentanyl.csv")
write.csv(morphine, file = "Morphine.csv")
write.csv(oxycodone, file = "Oxycodone.csv")
write.csv(hydrocodone, file = "Hydrocodone.csv")
write.csv(percocet, file = "Percocet.csv")
write.csv(hydromorphone, file = "Hydromorphone.csv")
```

```{r, cache = TRUE}
Fentanyl <- read_csv("/SSmimic/Medication/Fentanyl.csv")
Hydromorphone <- read_csv("/SSmimic/Medication/Hydromorphone.csv")
Morphine <- read_csv("/SSmimic/Medication/Morphine.csv")
Oxycodone <- read_csv("/SSmimic/Medication/Oxycodone.csv")
Percocet <- read_csv("/SSmimic/Medication/Percocet.csv")
Hydrocodone <- read_csv("/SSmimic/Medication/Hydrocodone.csv")
```

```{r}
#create tables with no duplicated hadm_id
Fent<- Fentanyl %>% distinct(hadm_id, .keep_all = TRUE)
Hydrom<- Hydromorphone %>% distinct(hadm_id, .keep_all = TRUE)
Morph<- Morphine %>% distinct(hadm_id, .keep_all = TRUE)
Oxycod<- Oxycodone %>% distinct(hadm_id, .keep_all = TRUE)
Perco <- Percocet %>% distinct(hadm_id, .keep_all = TRUE)
Hydrocod<- Hydrocodone %>% distinct(hadm_id, .keep_all = TRUE)

#create combined opioid medication table
opioid <- rbind(Fent,Hydrom, Morph, Oxycod, Perco, Hydrocod)
opioid_nohadmid<-  opioid %>% distinct(hadm_id, .keep_all = TRUE)

#create csv
write.csv(opioid, file = "opioid.csv")

#create  table with only IV drug presiscriptions and remove duplicated hadm_id

IVtable<- opioid[(opioid$route == "IV") |(opioid$route == "IV DRIP")|(opioid$route == "IVPCA") , ]
IVtable_nodup<-  IVtable %>% distinct(hadm_id, .keep_all = TRUE)
write.csv(IVtable_nodup,file = "IVtable_nodup.csv")


#create  table with NO IV drug presiscriptions and remove duplicated hadm_id

oralopioid<- opioid[!((opioid$route == "IV") |(opioid$route == "IV DRIP")|(opioid$route == "IVPCA")), ]
oralopioid_nodup<-  oralopioid %>% distinct(hadm_id, .keep_all = TRUE)
write.csv(oralopioid_nodup,file = "oralopioid_nodup.csv")

```

# Final Merge between patient cohort details (main.table.csv) and IV Opioid prescription information to ease analysis
```{r, cache = TRUE}
finaltable <- left_join(main.table , IVtable_nodup, "hadm_id")
finaltable <-  select(finaltable, "subject_id.y", "hadm_id", "icustay_id", "age", "gender", "ethnicity", "marital_status", "insurance", "los_hospital", "los_icu", "admityear", "mean.pain", "med.pain", "max_pain", "oasis", "e_score", "drug")
colnames(finaltable)[1] <- "subject_id"
```
# Changing inaccurate drug codes 
```{r}
finaltable$drug[finaltable$drug == "D5W"] <- NA
finaltable$drug[finaltable$drug == "Hydrocortisone Na Succinate"] <- NA
finaltable$drug[finaltable$drug == "Soln."] <- NA
finaltable$drug[finaltable$drug == "Soln"] <- NA
finaltable$drug[finaltable$drug == "Hydrocortiso"] <- NA
finaltable$drug[finaltable$drug == "Syringe"] <- NA
finaltable$drug[finaltable$drug == "5% Dextrose"] <- NA
```

```{r}
# Replacing NA to 0 and receiving an IV opioid to 1:
finaltable$drug<- ifelse(is.na(finaltable$drug),0,1)
View(finaltable)
```

```{r}
# categorize race into 4 categories

finaltable$ethnicity <- ifelse(grepl("BLACK",finaltable$ethnicity),"BLACK", finaltable$ethnicity)
finaltable$ethnicity <- ifelse(grepl("WHITE",finaltable$ethnicity),"WHITE", finaltable$ethnicity)
finaltable$ethnicity <- ifelse(grepl("HISPANIC",finaltable$ethnicity),"HISPANIC", finaltable$ethnicity)
finaltable$ethnicity <- ifelse(grepl("ASIAN",finaltable$ethnicity),"OTHER", finaltable$ethnicity)
finaltable$ethnicity <- ifelse(grepl("UN",finaltable$ethnicity),"OTHER", finaltable$ethnicity)
finaltable$ethnicity <- ifelse(grepl("MUL",finaltable$ethnicity),"OTHER", finaltable$ethnicity)
finaltable$ethnicity <- ifelse(grepl("INDIAN",finaltable$ethnicity),"OTHER", finaltable$ethnicity)
finaltable$ethnicity <- ifelse(grepl("SOUTH",finaltable$ethnicity),"OTHER", finaltable$ethnicity)
finaltable$ethnicity <- ifelse(grepl("ISLAND",finaltable$ethnicity),"OTHER", finaltable$ethnicity)
finaltable$ethnicity <- ifelse(grepl("DECL",finaltable$ethnicity),"OTHER", finaltable$ethnicity)
finaltable$ethnicity <- ifelse(grepl("EAST",finaltable$ethnicity),"OTHER", finaltable$ethnicity)
finaltable$ethnicity <- ifelse(grepl("PORTU",finaltable$ethnicity),"HISPANIC", finaltable$ethnicity)

finaltable$ethnicity[is.na(finaltable$ethnicity)]<-"OTHER"

#categorize marital status into 4 categories 

finaltable$marital_status <- ifelse(grepl("MARRIED",finaltable$marital_status),"MARRIED", finaltable$marital_status)
finaltable$marital_status <- ifelse(grepl("LIFE PARTNER",finaltable$marital_status),"MARRIED", finaltable$marital_status)
finaltable$marital_status <- ifelse(grepl("DIVORCED",finaltable$marital_status),"DIVORCED/WIDOWED", finaltable$marital_status)
finaltable$marital_status <- ifelse(grepl("SEPARATED",finaltable$marital_status),"DIVORCED/WIDOWED", finaltable$marital_status)

finaltable$marital_status <- ifelse(grepl("WIDOW",finaltable$marital_status),"DIVORCED/WIDOWED", finaltable$marital_status)
finaltable$marital_status <- ifelse(grepl("UN",finaltable$marital_status),"OTHER", finaltable$marital_status)

finaltable$marital_status[is.na(finaltable$marital_status)]<-"OTHER"

#categorize insurance into 3 catergories

finaltable$insurance <- ifelse(grepl("Medi",finaltable$insurance),"Government", finaltable$insurance)

#check that ethnicity, marital status and insurance were correctly categorised

unique(finaltable$ethnicity)

unique(finaltable$marital_status)

unique(finaltable$insurance)
```

```{r}
finaltable$insurance<- as.factor(finaltable$insurance)
finaltable$ethnicity<- as.factor(finaltable$ethnicity)
finaltable$marital_status<- as.factor(finaltable$marital_status)
finaltable$ethnicity<- relevel(finaltable$ethnicity, ref = "WHITE")
finaltable$marital_status<- relevel(finaltable$marital_status, ref = "MARRIED")
```

#Writing final .csv
```{r}
write.csv(finaltable, file = "finaltable.csv")
# Sample size
length(unique(finaltable$hadm_id))
```
